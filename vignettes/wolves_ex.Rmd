---
title: "Wolves Example"
author: "Brian Stock"
date: "March 7, 2016"
output: html_vignette
vignette: >
  %\VignetteIndexEntry{Wolves Example}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc} 
---

```{r, include=FALSE}
options(device="cairo_pdf")
# options(device = function(file, width = 7, height = 7, ...)  {cairo_pdf(tempfile(), width = width, height = height, ...)})
#knitr::opts_chunk$set(dev = "cairo_pdf")
```

Here we show how to do a mixing model analysis using the **script** version of MixSIAR. For a demonstration of the **GUI** version, see the [MixSIAR Manual](https://github.com/brianstock/MixSIAR/blob/master/mixsiar_manual_3.0.pdf). 

While the GUI may be convenient for users less familiar with R, we advise using the script version of MixSIAR for several reasons:

1. *Repeatability*: You can run different models and have a record of the commands that created each one. There are many reasons you'd want to do this. For example, you may want to compare model results with an uninformative prior vs. an informative prior, one error term option vs. another, grouping sources a priori vs. a posteriori, etc.

2. *Speed*: Clicking through the GUI buttons can get onerous after a while.

3. *Installation ease*: Some users aren't able to install the GTK+ software that the GUI depends on (more issues on Mac). It may be worth figuring out the script version (R skills!) instead of figuring out how to get GTK+ installed.

The basic MixSIAR workflow is the same using a script or the GUI:

1. Load data files:
    + Mixture (["load_mix_data"](#load-mixture-data))
    + Sources (["load_source_data"](#load-source-data))
    + Discrimination (TDF) (["load_discr_data"](#load-discrimination-data))
    
2. Pre-model checks
    + Plot your data (["plot_data"](#plot-data))
    + Calculate convex hull area (["calc_area"](#calculate-convex-hull-area))
    + Plot your prior (["plot_prior"](#plot-prior))

3. Choose model structure options
    + Write JAGS model file (["write_JAGS_model"](#write-JAGS-model-file))
    
4. Run model
    + Run the JAGS model (["run_model"](#run-model))

5. Use diagnostics to decide if the model has converged
    + Check diagnostics (["output_JAGS"](#analyze-diagnostics-and-output))

6. Analyze output
    + Check summary statistics and posterior density plots (["output_JAGS"](#analyze-diagnostics-and-output))

## Wolves Example

The "Wolves Example" uses data reconstructed from (not identical to) [Semmens et al. 2009](http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0006187). Here, we investigate the diet of 66 wolves in British Columbia with:

+ 2 biotracers ($\delta^{13}$C, $\delta^{15}$N)
+ 2 random effects (Region and Pack), where Pack is nested within Region
+ Source data as means and SDs (by Region)
+ Resid * Process error

### Load MixSIAR package

```{r}
library(MixSIAR)
```

### Load mixture data

```{r}
# Replace the system.file call with the path to your file
mix.filename <- system.file("extdata", "wolves_consumer.csv", package = "MixSIAR")

# Load the mixture/consumer data
mix <- load_mix_data(filename=mix.filename, 
                     iso_names=c("d13C","d15N"), 
                     factors=c("Region","Pack"), 
                     fac_random=c(TRUE,TRUE), 
                     fac_nested=c(FALSE,TRUE), 
                     cont_effects=NULL)
```

### Load source data

```{r}
# Replace the system.file call with the path to your file
source.filename <- system.file("extdata", "wolves_sources.csv", package = "MixSIAR")

# Load the source data
source <- load_source_data(filename=source.filename,
                           source_factors="Region", 
                           conc_dep=FALSE, 
                           data_type="means", 
                           mix)
```

### Load discrimination data

```{r}
# Replace the system.file call with the path to your file
discr.filename <- system.file("extdata", "wolves_discrimination.csv", package = "MixSIAR")

# Load the discrimination/TDF data
discr <- load_discr_data(filename=discr.filename, mix)
```

### Plot data

This is your chance to check:

+ Are the data loaded correctly?
+ Is your mixture data in the source polygon?
+ Are one or more of your sources confounded/hidden?

```{r}
# Make an isospace plot
plot_data(filename="isospace_plot", plot_save_pdf=TRUE, plot_save_png=FALSE, mix,source,discr)
```

### Calculate convex hull area

```{r}
# Calculate the convex hull area, standardized by source variance
calc_area(source=source,mix=mix,discr=discr)
```

### Plot prior

```{r}
# Plot your prior on the overall proportions. Here we use an uninformative prior.
plot_prior(alpha.prior=1,source)
```

### Write JAGS model file
    
**Note:** if you have only 1 mix datapoint, you have no information about the mixture/consumer variability. In this case, we use the original MixSIR error model (which does not fit a residual error term). This is the same as 'siarsolo' in SIAR.

```{r}
# Write the JAGS model file
model_filename <- "MixSIAR_model.txt"   # Name of the JAGS model file
resid_err <- TRUE
process_err <- TRUE
write_JAGS_model(model_filename, resid_err, process_err, mix, source)
```

### Run model

MCMC run options:

| run ==  | Chain Length | Burn-in | Thin | # Chains |
| ------------- | ------------- | ------------- | ------------- | ------------- |
| "test" | 1,000 | 500 | 1 | 3 |
| "very short" | 10,000 | 5,000 | 5 | 3 |
| "short" | 50,000 | 25,000 | 25 | 3 |
| "normal" | 100,000 | 50,000 | 50 | 3 |
| "long" | 300,000 | 200,000 | 100 | 3 |
| "very long" | 1,000,000 | 500,000 | 500 | 3 |
| "extreme" | 3,000,000 | 1,500,000 | 500 | 3 |

You can also set custom MCMC parameters, e.g:
```{r}
# run <- list(chainLength=200000, burn=150000, thin=50, chains=3, calcDIC=TRUE)
```

Good idea to use `run = "test"` first to check if 1) the data are loaded correctly and 2) the model is specified correctly:
```{r, eval=FALSE}
# Run the JAGS model. 
# "jags.1" will be an rjags object where you can access the MCMC chains for 
# plotting, aggregating sources a posteriori, etc.
jags.1 <- run_model(run="test", mix, source, discr, model_filename, 
                    alpha.prior = 1, resid_err, process_err)
```

### Analyze diagnostics and output

```{r, eval=FALSE}
# Set output options like file names, plot file types, etc.
output_options <- list(summary_save = TRUE,                  # Save the summary statistics as a txt file?
                       summary_name = "summary_statistics",  # Summary file name (.txt added later)
                       sup_post = FALSE,                     # Suppress posterior density plot output in R?
                       plot_post_save_pdf = TRUE,            # Save posterior density plots as pdfs?
                       plot_post_name = "posterior_density", # Posterior plot file names (.pdf/.png added later)
                       sup_pairs = FALSE,                    # Suppress pairs plot output in R?
                       plot_pairs_save_pdf = TRUE,           # Save pairs plot as pdf?
                       plot_pairs_name = "pairs_plot",       # Pairs plot file name (.pdf/.png added later)
                       sup_xy = TRUE,                        # Suppress xy/trace plot output in R?
                       plot_xy_save_pdf = FALSE,             # Save xy/trace plot as pdf?
                       plot_xy_name = "xy_plot",             # XY plot file name (.pdf/.png added later)
                       gelman = TRUE,                        # Calculate Gelman-Rubin diagnostic test?
                       heidel = FALSE,                       # Calculate Heidelberg-Welch diagnostic test?
                       geweke = TRUE,                        # Calculate Geweke diagnostic test?
                       diag_save = TRUE,                     # Save the diagnostics as a txt file?
                       diag_name = "diagnostics",            # Diagnostics file name (.txt added later)
                       indiv_effect = FALSE,                 # Is Individual a random effect in the model?
                       plot_post_save_png = FALSE,           # Save posterior density plots as pngs?
                       plot_pairs_save_png = FALSE,          # Save pairs plot as png?
                       plot_xy_save_png = FALSE)             # Save xy/trace plot as png?

# Process diagnostics, summary statistics, and create posterior density plots
output_JAGS(jags.1, mix, source, output_options)

```
